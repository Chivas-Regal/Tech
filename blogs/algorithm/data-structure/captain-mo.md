---
key: 2021-09-11-è«é˜Ÿç®—æ³•
layout: article
title: è«é˜Ÿç®—æ³•
subtitle: ç¦»çº¿æ“ä½œå•Šï¼Œå…ˆä¿å­˜åè¾“å‡ºï¼ŸğŸ¤”
categories: æ•°æ®ç»“æ„
tags: [æ•°æ®ç»“æ„]
aside:
  toc: true
sidebar: true
---

## æ™®é€šè«é˜Ÿ

### é—®é¢˜ç±»å‹
>ç»™å®š$m$ä¸ªæŸ¥è¯¢æ“ä½œï¼Œæ²¡æœ‰ä¿®æ”¹æ“ä½œï¼Œæ¯æ¬¡æŸ¥è¯¢$[l,r]$æœ‰å¤šå°‘ä¸ªä¸åŒçš„æ•°

### ä½œç”¨

å¯ä»¥è§£å†³<span style="color: red;">åŒºé—´ç¦»çº¿é—®é¢˜</span>çš„ç¦»çº¿ç®—æ³•ï¼Œå¦‚æœåœ¨çº¿å¯èƒ½ä¼šTæ‰  
æ—¶é—´ä¸º $O(nlogn)$ ï¼Œä½†å¯èƒ½ä¼šæœ‰å‡ºé¢˜äººå¡è«é˜Ÿ  

### ä¼˜åŒ–ç­–ç•¥

#### åŒæŒ‡é’ˆ


>ç»™ä¸ªæ•°åˆ—æœ‰è‹¥å¹²æ¬¡è¯¢é—® $[L,R]$ çš„åŒºé—´å’Œï¼ˆå¼ºåˆ¶è«é˜Ÿï¼‰
>  
>è§£ï¼šå¼€ä¸ªæ•°ç»„  
>
>|$0$|$1$|$2$|$3$|$4$|$5$|$6$|$7$|$8$|$9$|  
>|-|-|-|-|-|-|-|-|-|-|  
>||$3$|$8$|$1$|$2$|$7$|$4$|$9$|$0$|$6$|  
>
>è‹¥ç°åœ¨çŸ¥é“ $[2,5]$ åŒºé—´å’Œä¸º18   
>&nbsp;&nbsp;&nbsp;æ±‚ $[2,6]$ çš„åŒºé—´å’Œ $\Rightarrow$ åŠ ä¸Šç¬¬6é¡¹çš„å€¼  
>&nbsp;&nbsp;&nbsp;æ±‚ $[2,4]$ çš„åŒºé—´å’Œ $\Rightarrow$ åˆ æ‰ç¬¬5é¡¹çš„å€¼ 

æœ´ç´ æ¥çœ‹ï¼Œå¯¹äºåŒºé—´ $[L, R]$ :<ol>
	<li>åŠ ä¸Šå·¦è¾¹ä¸€æ ¼è´¡çŒ®: $add(--l)$</li>
	<li>åŠ ä¸Šå³è¾¹ä¸€æ ¼è´¡çŒ®: $add(++r)$</li>
	<li>å‡å»å·¦è¾¹ä¸€æ ¼è´¡çŒ®: $sub(++l)$</li>
	<li>å‡å»å³è¾¹ä¸€æ ¼è´¡çŒ®: $sub(--r)$</li>
</ol>

#### æ’åºåˆ†å—

>è‹¥è¯¢é—® $m$ æ¬¡ï¼Œ$[1,2],\;[n-1,n],\;[1,2],\;[n-1,n],\;[1,2].....$ ï¼Œä¸Šé¢çš„æ–¹æ³•å°±å˜æˆäº† $O(mn)$  
>
>å¯ä»¥æ”¹æˆ $[1,2],\;[1,2],\;[1,2],\;[n-1,n],\;[n-1,n]\;[n-1,n]...$  


è¿™æ ·å°†è·ç¦»è¾ƒè¿‘çš„åŒºé—´æ”¾åœ¨ä¸€èµ·ï¼Œæ—¶é—´å¤æ‚åº¦å˜æˆ $O(n+m)$

### ç®—æ³•æ¶æ„

|--åˆ†å—  
|--è®°å½•è¯¢é—®  
|--æ’åº  
|--éå†è¯¢é—®  
|----è‹¥å·¦è¾¹çŸ­ï¼Œå·¦æŒ‡é’ˆå‘å·¦åŠ ä¸€ä¸ªæ•°  
|----è‹¥å³è¾¹çŸ­ï¼Œå³æŒ‡é’ˆå‘å³åŠ ä¸€ä¸ªæ•°  
|----è‹¥å·¦è¾¹é•¿ï¼Œå·¦æŒ‡é’ˆå‘å³å‡ä¸€ä¸ªæ•°  
|----è‹¥å³è¾¹é•¿ï¼Œå³æŒ‡é’ˆå‘å·¦å‡ä¸€ä¸ªæ•°  
|----è®°å½•ç­”æ¡ˆå­˜å…¥æ–°æ•°ç»„  
|--ä»¥æ–°æ•°ç»„é¡ºåºè¾“å‡º  

>[é»‘æš—çˆ†ç‚¸-1878ã€ŠHHçš„é¡¹é“¾ã€‹](https://vjudge.net/problem/%E9%BB%91%E6%9A%97%E7%88%86%E7%82%B8-1878)

```cpp
const int N = 1e4 + 10;
int pos[N];
int a[N];
int res[N];
int RES;
struct Q{
        int l, r, id;
}q[N];
int main () {
#ifndef ONLINE_JUDGE
        freopen("in.in", "r", stdin);
        freopen("out.out", "w", stdout);
#endif
        // n m l r
        int n, m, l, r;
        cin >> n >> m >> l >> r;
        // åˆ†å—
        int len = sqrt(n);
        for ( int i = 1; i <= n; i ++ )
                cin >> a[i],
                pos[i] = i / len;
        // è¯¢é—®
        for ( int i = 0; i < m; i ++ )
                cin >> q[i].l >> q[i].r,
                q[i].id = i;
        // æ’åº
        sort (q, q + m, [](Q x, Q y){
                return pos[x.l] == pos[y.l] ? x.r < y.r : pos[x.l] < pos[y.l];
        });
        // åˆå§‹åŒ–ä¸ºå¼€åŒºé—´
        int l = 1, r = 0;
        for ( int i = 0; i < m; i ++ ) {
                // å·¦è¾¹å¤ªçŸ­äº†ï¼Œlå‘å·¦åŠ ä¸€æ ¼
                while ( q[i].l < l ) Add ( -- l );
                // å³è¾¹å¤ªçŸ­äº†ï¼Œrå‘å³åŠ ä¸€æ ¼
                while ( q[i].r > r ) Add ( ++ r );
                // å·¦è¾¹å¤ªé•¿äº†ï¼Œlå‘å³å‡ä¸€æ ¼
                while ( q[i].l > l ) Sub ( ++ l );
                // å³è¾¹å¤ªé•¿äº†ï¼Œrå‘å·¦å‡ä¸€æ ¼
                while ( q[i].r < r ) Sub ( -- r );
                // è®°å½•ç­”æ¡ˆ
                res[q[i].id] = RES;
        }
        for ( int i = 0; i < m; i ++ )
                cout << res[i] << endl;
        return 0;
}

```

## å¸¦ä¿®è«é˜Ÿ  

### é—®é¢˜ç±»å‹
>å¤šäº†ä¸ªä¿®æ”¹çš„ç‰ˆæœ¬é—®é¢˜ï¼Œç±»ä¼¼äºæ—¶é—´  
  
é‚£ä¹ˆå¯ä»¥<span style="color: red;">åŠ ä¸€ç»´è®°å½•æ—¶é—´æˆ³</span>  
æ¯æ¬¡æŸ¥è¯¢å¯ä»¥ç¡®å®šä¸€ä¸‹ç‰ˆæœ¬ï¼Œå³ç¬¬ $k$ æ¬¡ä¿®æ”¹ä¹‹åï¼Œç¬¬k+1æ¬¡ä¿®æ”¹ä¹‹å‰  
   
### æŒ‡é’ˆç§»åŠ¨
åœ¨åŒç‰ˆæœ¬ä¸‹çš„ç§»åŠ¨ $[l, r]$ å¯ä»¥æ˜¯æ™®é€šè«é˜Ÿ  
åœ¨<span style="color: red;">è·³ç‰ˆæœ¬</span>ä¸‹ç§»åŠ¨ $[l, r, t]$ è¦<span style="color: red;">è€ƒè™‘ä¸¤ç§æƒ…å†µ</span>  
1.ä¿®æ”¹çš„æ•°åœ¨åŒºé—´å¤–ï¼Œä¸ç”¨ç†ä¼š  
2.ä¿®æ”¹çš„æ•°åœ¨åŒºé—´å†…ï¼Œè®¡æ•°å‡ä¸€ä¸‹ä¿®æ”¹å‰çš„æ•°ï¼Œå†åŠ ä¸€ä¸‹ä¿®æ”¹åçš„æ•°  
  
### ä¿®æ”¹æ“ä½œ  
å¯ä»¥æŠŠä¿®æ”¹æ“ä½œè®°å½•ä¸€ä¸ªæ•°ç»„ï¼Œæ¯æ¬¡ä¿®æ”¹çš„æ•°ç»„å†…å­˜æ”¾è¿™æ¬¡ä¿®æ”¹çš„æ˜¯ä»€ä¹ˆæ•°  
é‚£ä¹ˆåœ¨æŒ‡é’ˆç§»åŠ¨çš„æ—¶å€™æˆ‘ä»¬åªéœ€è¦å°†åŸä½ç½®çš„æ•°å’Œä¿®æ”¹åçš„æ•°<span style="color:red;">äº¤æ¢ä¸€ä¸‹</span>

### æ’åºä¼˜å…ˆçº§
$l$ æ‰€åœ¨å—ç¼–å·ï¼Œ $r$ æ‰€åœ¨å—ç¼–å·ï¼Œ $t$ é¡ºç€é€’å¢
å—é•¿ä¸º $O(\sqrt[3]{nt})$

### æ€æƒ³æ€»ç»“  
å¸¦ä¿®è«é˜Ÿå¤šäº†ä¸ª<span style="color:red;">æ—¶é—´æˆ³</span>çš„ç§»åŠ¨  
ä¹Ÿå¯ä»¥è¢«è§†ä½œç¬¬ä¸‰ä¸ªæŒ‡é’ˆ  
å…¶ä¸­å¯ä»¥åšä¹Ÿæ˜¯å¿…åšçš„ä¼˜åŒ–å°±æ˜¯æˆ‘ä»¬å†ä¿®æ”¹çš„çš„æ—¶å€™è®°å½•æ“ä½œè€Œä¸æ˜¯ç›´æ¥ä¿®æ”¹ï¼Œå› ä¸ºæ—¶é—´æˆ³æŒ‡é’ˆå¯èƒ½ä¼šæ¥å›æŠ˜è¿”ï¼Œæˆ‘ä»¬è¦çŸ¥é“ä¸‹ä¸€æ­¥è¦æ”¹æˆä»€ä¹ˆ  
åœ¨ç§»åŠ¨æ—¶é—´æˆ³æ—¶ï¼Œèµ°è¿‡æŸä¸ªä¿®æ”¹æ—¶åªéœ€è¦å°†ä¿®æ”¹çš„å€¼å’ŒåŸå§‹å€¼è°ƒæ¢ä¸€ä¸‹  
å¦‚æœåœ¨åŒºé—´å¤–ä¹Ÿè¦äº¤æ¢ï¼Œå› ä¸ºä¹‹åéå† $[L,R]$ ä¹Ÿä¼šèµ°è¿‡å»  


### ç®—æ³•æ¶æ„
|--è®°å½•æŸ¥è¯¢  
|--è®°å½•ä¿®æ”¹  
|--å¯¹æŸ¥è¯¢æ’åº  
|--ä¸‰ä¸ªæŒ‡é’ˆ
|----å·¦å³æŒ‡é’ˆåœ¨ä¸€ä¸ªç‰ˆæœ¬å†…è·‘æ¥å›ºå®š $[q.l,q.r]$ åŒºé—´
|----ç‰ˆæœ¬æŒ‡é’ˆåœ¨å¤šä¸ªç‰ˆæœ¬ä¸Šè·³
|------äº¤æ¢ä¿®æ”¹çš„æ•°å’ŒåŸæ•°
|------åˆ¤æ–­è¿™ä¸ªç‰ˆæœ¬ä¿®æ”¹æ˜¯å¦åœ¨å·¦å³æŒ‡é’ˆé‚£ï¼Œçœ‹çœ‹éœ€ä¸éœ€è¦ä¿®æ”¹å½“å‰RES
|--å½•å…¥ç­”æ¡ˆ
|--è¾“å‡º

>[æ´›è°·-P1903ã€Š[å›½å®¶é›†è®­é˜Ÿ]æ•°é¢œè‰² / ç»´æŠ¤é˜Ÿåˆ—ã€‹](https://www.luogu.com.cn/problem/P1903)

```cpp
const int N = 1e4 + 10, M = 1e6 + 10;

int cnt[M], a[N], res[N], pos[N];
int n, m, len;
int nq, nm, RES;
struct Q{
	int l, r, t, id;
}qry[N];
struct M{
	int x, y;
}mdf[N];

inline void add ( int x ) {
	RES += ! cnt[x] ++;
}
inline void sub ( int x ) {
	RES -= ! -- cnt[x];
}

int main () {
	scanf("%d%d", &n, &m);
	for ( int i = 1; i <= n; i ++ )
		scanf("%d", &a[i]);
	for ( int i = 1; i <= m; i ++ ) {
		char op[2]; int x, y;
		scanf("%s%d%d", op, &x, &y);
		if ( op[0] == 'Q' ) ++ nq, qry[nq] = { x, y, nm, nq };
		else                ++ nm, mdf[nm] = { x, y };
	} 
	len = cbrt ((double)n * nm) + 1;
	for ( int i = 1; i <= m; i ++ ) 
		pos[i] = i / len;
	sort ( qry + 1, qry + 1 + nm, [&]( Q a, Q b ){
		if ( pos[a.l] != pos[b.l] ) return pos[a.l] < pos[b.l];
		if ( pos[a.r] != pos[b.r] ) return pos[a.r] < pos[b.r];
		if ( pos[a.r] & 1 ) return a.t > b.t;
		return a.t < b.t;		
	});
	
	for ( int L = 1, R = 0, T = 0, k = 1; k <= nq; k ++ ) {
		while ( L < qry[k].l ) sub ( a[L ++] );
		while ( L > qry[k].l ) add ( a[-- L] );
		while ( R < qry[k].r ) add ( a[++ R] );
		while ( R > qry[k].r ) sub ( a[R --] );
		while ( T != qry[k].t ) {
			if ( T < qry[k].t ) T ++;
			if ( L <= mdf[T].x && mdf[T].x <= R ) 
				sub ( a[mdf[T].x] ),
				add ( mdf[T].y );
			swap ( a[mdf[T].x], mdf[T].y );
			if ( T > qry[k].t ) T --;
		}
		res[qry[k].id] = RES;
	}
	for ( int i = 1; i <= nq; i ++ ) 
		printf("%d\n", res[i]);
	return 0;
}
```

## å›æ»šè«é˜Ÿ  

### é—®é¢˜ç±»å‹

>ç»™å®šä¸€ä¸ªæ•°åˆ—ï¼Œå¤šä¸ªæŸ¥è¯¢åŒºé—´æ–°å®šä¹‰çš„æœ€å¤§å€¼  
è¿™ç§å¥½å¢åŠ <span style="color: red;">ä¸å¥½åˆ é™¤</span>çš„é—®é¢˜  
  
æˆ‘ä»¬å¯ä»¥<span style="color: red;">å…¨ä½¿ç”¨å¢åŠ æ“ä½œ</span>æ¥è¿›è¡Œè·‘æŒ‡é’ˆ  

### æ–°éå†æ–¹æ³•  
æˆ‘ä»¬åœ¨å›æ»šè«é˜Ÿä¸­ä¸€æ¬¡è€ƒè™‘ä¸€æ•´ä¸ªå—å…¶ä¸­æ‰€æœ‰çš„è¯¢é—®$l$åœ¨è¯¥å—å†…ç‚¹è¯¢é—®  
è¿™äº›è¯¢é—®$r$é€’å¢  

### åˆ†ç±»è®¨è®º  
è¿™æ ·éå†æ—¶ä¼šå‡ºç°ä¸¤ç§æƒ…å†µï¼š  
1.å¼€å§‹æ—¶$l$å’Œ$r$åœ¨åŒä¸€ä¸ªå—å†…  
2.åé¢$l$å’Œ$r$ä¸åœ¨åŒä¸€ä¸ªå—å†…  
  
**æƒ…å†µ1ï¼š**  
ç”±äºä¸€ä¸ªå—å†…é•¿åº¦ä¸è¶…è¿‡ $\sqrt{n}$ ï¼Œæ‰€ä»¥<span style="color: red;">ç›´æ¥æš´åŠ›</span>å³å¯  
ä½†è¿™æ³¢æš´åŠ›æ˜¯æ²¡æœ‰æ”¶ç›Šç‚¹ï¼Œåªèƒ½ç”¨æ¥è®°ä¸€ä¸‹ç­”æ¡ˆï¼Œéå†å®Œè¦æ¸…ä¸€ä¸‹ $cnt[]$ æ•°ç»„  
**æƒ…å†µ2ï¼š**  
æˆ‘ä»¬å°†æŸ¥è¯¢çš„åŒºé—´<span style="color:red;">åˆ†ä¸ºä¸¤éƒ¨åˆ†</span>  
1.åœ¨$l$æ‰€åœ¨çš„å—å†…  
å¯¹äºè¿™éƒ¨åˆ†åŒæ ·æˆ‘ä»¬å¯ä»¥æš´åŠ›è§£å†³ï¼Œç»“æŸäº†ä¹Ÿè¦æ¸…ä¸€ä¸‹æ•°ç»„  
2.ä¸åœ¨$l$æ‰€åœ¨çš„å—å†…  
è¿™æ ·çš„æ‰€æœ‰åŒºé—´å·¦ç«¯ç‚¹éƒ½å›ºå®šåœ¨$l$çš„ä¸‹ä¸€ä¸ªå—çš„ç¬¬ä¸€ä¸ªä½ç½®  
è¿™äº›åŒºé—´éå†æ—¶åªå‰è¿›å³ç«¯ç‚¹  
æˆ‘ä»¬å®Œå…¨å¯ä»¥åªä½¿ç”¨è«é˜Ÿçš„ $add$ æ“ä½œæ¥å®ç°  

### æ€æƒ³æ€»ç»“  
æ—¢ç„¶ä½¿ç”¨åˆ é™¤æ“ä½œå¾ˆéº»çƒ¦ï¼Œé‚£ä¹ˆå°±ä¸ä½¿ç”¨åˆ é™¤æ“ä½œ  
å¯¹äºä¸€ä¸ªçŸ­åˆ°ä¸€ä¸ªå—å†…çš„åŒºé—´ï¼Œç›´æ¥ä½¿ç”¨æš´åŠ›æ±‚è§£  
å¯¹äºè·¨åŒºé—´çš„å—ï¼Œå°†å…¶æŒ‰å·¦ç«¯ç‚¹å—ç¼–å·åˆ†ç±»ä¹‹åï¼Œå¯ä»¥å°†åŒä¸€ç±»çš„æ¯ä¸ªåŒºé—´åˆ†ä¸ºå·¦è¾¹çš„ä¸åˆ° $\sqrt{n}$ çš„å°åŒºé—´å’Œå³è¾¹ä¸æ–­å‰è¿›çš„å¤§åŒºé—´ï¼Œå·¦è¾¹æš´åŠ›å³è¾¹è«é˜Ÿå³å¯è§£å†³é—®é¢˜  

### ç®—æ³•æ¶æ„  
|--è¯»å…¥æ•°æ®ã€æ’åºè¯¢é—®  
|--éå†è¯¢é—®  
|----å¼€å§‹æ—¶ $get(l)=get(r)$ ï¼Œç›´æ¥æš´åŠ›  
|----åé¢æ—¶ $get(l)\neq get(r)$  
|------å¯¹ $get(l)$ å—ä¸‹çš„éƒ¨åˆ†åŒºé—´è¿›è¡Œæš´åŠ›  
|------å¯¹å…¶ä½™éƒ¨åˆ†åŒºé—´è¿›è¡Œè«é˜Ÿé€’è¿› $add$  
|--è¾“å‡ºç­”æ¡ˆ  

>[æ´›è°·-P5906ã€Šã€æ¨¡æ¿ã€‘å›æ»šè«é˜Ÿ&ä¸åˆ é™¤è«é˜Ÿã€‹]()

```cpp
const int N = 1e5 + 10;
int n, m, len;
int w[N], cnt[N];
ll res[N];
struct Q{
        int id, l, r;
}q[N];
vector<int> nums;

inline int get ( int x ) { return x / len;}

inline void add ( int x, ll &RES ) {
        cnt[x] ++;
        RES = max ( RES, (ll)cnt[x] * nums[x] );
}

int main () {
#ifndef ONLINE_JUDGE
        freopen("in.in", "r", stdin);
        freopen("out.out", "w", stdout);
#endif
        scanf("%d%d", &n, &m); len = sqrt(n);
        for ( int i = 1; i <= n; i ++ ) 
                scanf("%d", &w[i]), 
                nums.push_back(w[i]);

        //ç¦»æ•£åŒ–
        sort ( nums.begin(), nums.end() );
        nums.erase(unique(nums.begin(), nums.end()), nums.end());
        for ( int i = 1; i <= n; i ++ ) 
                w[i] = lower_bound(nums.begin(), nums.end(), w[i]) - nums.begin(); 
        
        // è¯¢é—®è¯»å…¥ä¸æ’åº
        for ( int i = 0; i < m; i ++ ) {
                int l, r; scanf("%d%d", &l, &r);
                q[i] = {i, l, r};
        }
        
        sort ( q, q + m, [] ( Q a, Q b ) {
                if ( get(a.l) != get(b.l) ) return get(a.l) < get(b.l);
                return a.r < b.r;
        });

        // éå†è¯¢é—®
        for ( int x = 0; x < m; ) {
                int y = x;
                while ( y < m && get(q[y].l) == get(q[x].l) ) y ++; // [x,y-1]çš„åŒºé—´å†…éƒ½æ˜¯.lç›¸ç­‰çš„æŸ¥è¯¢
                int right = get(q[x].l) * len + len - 1; // q[x].læ‰€åœ¨çš„å—çš„æœ€åä¸€ä¸ªç‚¹

                // q[x].lå’Œq[x].råœ¨åŒä¸€ä¸ªå—å†…ï¼Œç›´æ¥æš´åŠ›æ±‚
                while ( x < y && q[x].r <= right ) { 
                        ll RES = 0; 
                        for ( int k = q[x].l; k <= q[x].r; k ++ ) add ( w[k], RES );
                        res[q[x].id] = RES;
                        for ( int k = q[x].l; k <= q[x].r; k ++ ) cnt[w[k]] --; // å›åˆ°æ›´æ–°å‰çš„æ•°æ®çŠ¶æ€
                        x ++;
                }
                
                // æ±‚åœ¨ä¸åŒå—å†…çš„è¯¢é—®
                ll RES = 0;
                int i = right, j = right + 1; // å³ç«¯ç‚¹å’Œå·¦ç«¯ç‚¹
                while ( x < y ) {
                        while ( i < q[x].r ) add ( w[ ++ i ], RES ); // å³ç«¯ç‚¹ç§»åŠ¨åˆ°æ­£ç¡®çš„ä½ç½®
                        ll backup = RES; // å¤‡ä»½ä¸€ä¸‹
                        while ( j > q[x].l ) add ( w[ -- j ], RES ); // å·¦ç«¯ç‚¹ç§»åŠ¨åˆ°æ­£ç¡®çš„ä½ç½®
                        res[q[x].id] = RES;
                        while ( j < right + 1 ) cnt[w[j ++]] --; // å·¦ä¾§å›åˆ°æ›´æ–°å‰çš„æ•°æ®çŠ¶æ€ï¼Œå› ä¸ºå·¦ä¾§ä¸åˆ è¦é‡å¼€
                        RES = backup; // æ¢å¤å¤‡ä»½
                        x ++;
                }
                memset ( cnt, 0, sizeof cnt ); // è¿›è¡Œä¸‹ä¸€éƒ¨åˆ†çš„æŸ¥è¯¢å‰è¦æ¸…ç©º
        }
        for ( int i = 0; i < m; i ++ ) printf("%lld\n", res[i]);
        return 0;
}
```


## æ ‘ä¸Šè«é˜Ÿ  

### é—®é¢˜ç±»å‹
ç»™ä¸€ä¸ªæ— æ ¹æ™®é€šæ ‘ï¼Œè‹¥å¹²è¯¢é—®ï¼Œæ ‘çš„æŸæ¡è·¯å¾„ä¸Šä¸€å…±æœ‰å¤šå°‘ç§ä¸åŒæƒé‡
<img src="https://i.loli.net/2021/09/11/eCVfYKyq9wjRgWE.png">
æƒå€¼ï¼š
|1|2|3|4|5|6|7|8|
|-|-|-|-|-|-|-|-|
|45|2|9|1|8|5|7|7|

æ ‘ä¸Šçš„ä¿®æ”¹é—®é¢˜ï¼Œå¯ä»¥å˜æˆä¸€ä¸ªçº¿æ€§åŒºé—´ä¿®æ”¹é—®é¢˜  
åœ¨è¿™é‡Œå¯ä»¥ä½¿ç”¨æ¬§æ‹‰åºåˆ—  


### æ¬§æ‹‰åºåˆ—

#### æ„é€ æ–¹å¼
**<span style="color: red;">å¯¹æ ‘DFSä¸€æ¬¡ï¼Œæ­£åºéå†åˆ°æ¯ä¸ªèŠ‚ç‚¹æ—¶è®°å½•ä¸€æ¬¡ï¼Œååºéå†å†è®°å½•ä¸€æ¬¡</span>**  
<span style="color:blue;">æ¯”å¦‚ä¸Šé¢çš„æ ‘å¯ä»¥å˜ä¸º$1$, $2$, $2$, $3$, $5$, $5$, $6$, $6$, $7$, $7$, $3$, $4$, $8$, $8$, $4$, $1$</span>       

#### æ€§è´¨
1.æ¯ä¸ªç‚¹è¿›å…¥å†™ä¸€æ¬¡ï¼Œç¦»å¼€å†™ä¸€æ¬¡ï¼Œå…±å†™ä¸¤æ¬¡  
2.æ¯æ¬¡è¯¢é—®è·¯å¾„ $(x\rightarrow y)$ é€‰åºåˆ—ä¸­xæœ€å¼€å§‹(æœ€å)å‡ºç°çš„ä½ç½®å’Œyæœ€å¼€å§‹å‡ºç°çš„ä½ç½®ï¼Œåªä¿ç•™ä¸­é—´å‡ºç°è¿‡ä¸€æ¬¡çš„æ•°  

#### æ“ä½œæ–¹å¼

ä¸¤ä¸ªæ•°ç»„   
$first[u]$ è¡¨ç¤º $u$ ç¬¬ä¸€æ¬¡å‡ºç°çš„ä½ç½®  
$last[u]$ è¡¨ç¤º $u$ ç¬¬äºŒæ¬¡å‡ºç°çš„ä½ç½®  
é€‰ $x,y$ æ»¡è¶³ $x$ åœ¨ $y$ ä¹‹å‰å‡ºç°ï¼Œå³ $first[x]\lt first[y]$  

### åˆ†ç±»è®¨è®º  
1. $lca(x,y)=x$ ï¼Œåˆ™æ¬§æ‹‰åºåˆ—ä¸­ $first[x]\rightarrow first[y]$ ä¸­é—´åªå‡ºç°ä¸€æ¬¡çš„ç‚¹å¯¹åº” $x\rightarrow y$ çš„è·¯å¾„<span style="color: blue">ï¼ˆå› ä¸ºè‹¥å‡ºç°0æ¬¡è¯´æ˜æ²¡æœåˆ°ï¼Œè‹¥å‡ºç°ä¸¤æ¬¡è¯´æ˜è¿›å»æœäº†ä½†æ˜¯ä¸å­˜åœ¨</span>  
2. $lca(x,y)\neq x$ ï¼Œåˆ™è·¯å¾„å¯¹åº”æ¬§æ‹‰åºåˆ—ä¸­ $last[x]\rightarrow first[y]$ ä¸­åªå‡ºç°ä¸€æ¬¡çš„ç‚¹ä»¥åŠ $lca(x,y)$ <span style="color: blue;">ï¼ˆå› ä¸ºæœ€åçš„lcaä»æœªå›æº¯</span>

### æŒ‡é’ˆç§»åŠ¨  
ä¸‰ä¸ªæ•°ç»„  
$cnt[]$ è®°å½•æƒå€¼å‡ºç°çš„ä¸ªæ•°  
$st[]$ è®°å½•åºå·å‡ºç°çš„æ¬¡æ•°(0/1)ï¼Œ<span style="color: red;">æ›´æ–°ï¼š $st[]^=1$ </span>  
$res$ å®æ—¶è®°å½•ç­”æ¡ˆ  
  
```cpp
inline void add ( x ) {
        st[x] ^= 1;
        if ( st[x] == 0 ) res -= ! -- cnt[a[x]];
        else              res -= ! cnt[a[x]] --;
}
```
ç”±äºå‡å»ä¸€ä¸ªæ•°ä¹Ÿæ˜¯å¼‚æˆ–1ï¼Œæ‰€ä»¥ä¸€ä¸ª $add$ å°±å¤Ÿç”¨äº†

### æ€æƒ³æ€»ç»“  
å¯¹äºä¸€ä¸ªæ ‘ä¸Šé—®é¢˜ï¼Œæˆ‘ä»¬ä¸»è¦åˆ©ç”¨æ¬§æ‹‰åºåˆ—æŠŠå®ƒå˜æˆåŒºé—´é—®é¢˜  
ç„¶åå¯¹äºæ¬§æ‹‰åºåˆ—æ€§è´¨ï¼ˆæœ‰å…³lcaï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºæˆ‘ä»¬æ¯æ¬¡è¦å›ºå®šå“ªä¸ªåŒºé—´å’Œå“ªäº›æ•°  

### ç®—æ³•æ¶æ„  
|--æ±‚æ¬§æ‹‰åºåˆ—  
|--æ±‚ $lca$  
|----é¢„å¤„ç† $f[][]$    
|----å€å¢å‘ä¸Šè·³æ‰¾ $lca$    
|--æ ‘ä¸Šè¯¢é—® $\rightarrow$ åºåˆ—è¯¢é—®    
|--è«é˜Ÿ  

>[AcWing-2534 ã€Šæ ‘ä¸Šè®¡æ•°2ã€‹](https://www.acwing.com/problem/content/2536/)

```cpp
const int N = 100010;

int n, m, len;
int w[N]; // è¯»å…¥ç‚¹æƒ
struct Edge { int nxt, to; } edge[N]; int head[N], tot; 
int depth[N], f[N][16]; // å€å¢lcaé‚£ä¸€å¥—
int seq[N], top, first[N], last[N]; // æ¬§æ‹‰åºåˆ—ï¼Œå½“å‰ä½ç½®å‡ºç°çš„ä¸ªæ•°ï¼Œæœ€æ—©å‡ºç°çš„ä½ç½®å’Œæœ€åå‡ºç°çš„ä½ç½®
int cnt[N], st[N], res[N]; // æƒå€¼ä¸åŒä¸ªæ•°ï¼Œåºå·å‡ºç°çš„ä¸ªæ•°ï¼ˆå¥‡æ•°/å¶æ•°ï¼‰ï¼Œç­”æ¡ˆè®°å½•
int que[N]; // å®½æœé˜Ÿåˆ—
struct Qry {
        int id, l, r; // ç¬¬idä¸ªæŸ¥è¯¢ï¼ŒæŸ¥è¯¢åŒºé—´æ˜¯l, r
        int p; // æœ‰æ— æœ€è¿‘å…¬å…±ç¥–å…ˆ
}q[N];
vector<int> nums; // ç¦»æ•£åŒ–
int RES; // ç­”æ¡ˆå®æ—¶è®¡æ•°

inline void Add_Edge ( int from, int to ) {
        edge[ ++ tot ] = {head[from], to};
        head[from] = tot;
}

// -----------------------------------------------------------------æ±‚æ¬§æ‹‰åºåˆ—
inline void dfs ( int u, int father ) {
        seq[ ++ top ] = u;
        first[u] = top;
        for ( int i = head[u]; ~i; i = edge[i].nxt ) {
                int j = edge[i].to;
                if ( j != father ) dfs ( j, u );
        } 
        seq[ ++ top ] = u;
        last[u] = top;
}
// ---------------------------------------------------------------------------

// -------------------------------------------------------------------é¢„å¤„ç†å€å¢lca
inline int lca ( int a, int b ) {
        if ( depth[a] < depth[b] ) swap ( a, b );
        for ( int k = 15; k >= 0; k -- ) 
                if ( depth[f[a][k]] >= depth[b] ) 
                        a = f[a][k];
        if ( a == b ) return a;
        for ( int k = 15; k >= 0; k -- ) 
                if ( f[a][k] != f[b][k] ) 
                        a = f[a][k],
                        b = f[b][k];
        return f[a][0];
}

inline void bfs () {
        memset ( depth, 0x3f, sizeof depth );
        depth[0] = 0, depth[1] = 1;
        int hh = 0, tt = 0;
        que[0] = 1;
        while ( hh <= tt ) {
                int t = que[hh ++ ];
                for ( int i = head[t]; ~i; i = edge[i].nxt ) {
                        int to = edge[i].to;
                        if ( depth[to] > depth[t] + 1 ) {
                                depth[to] = depth[t] + 1;
                                f[to][0] = t;
                                for ( int k = 1; k <= 15; k ++ ) {
                                        f[to][k] = f[f[to][k - 1]][k - 1];
                                }
                                que[ ++ tt ] = to;
                        }
                }
        }
}
// ------------------------------------------------------------------------------------

// ----------------------------------------------------------------------------- è«é˜Ÿæ“ä½œ
inline int get ( int x ) { return x / len; }

inline void add ( int x ) {
        st[x] ^= 1;
        if ( st[x] == 0 ) {
                cnt[w[x]] --;
                if ( !cnt[w[x]] ) RES --;
        } else {
                if ( !cnt[w[x]] ) RES ++;
                cnt[w[x]] ++;
        }
}
// ------------------------------------------------------------------------------------

int main () {
#ifndef ONLINE_JUDGE
        freopen("in.in", "r", stdin);
        freopen("out.out", "w", stdout);
#endif
        // è¯»å…¥æ•°æ®å¹¶è¿›è¡Œç¦»æ•£åŒ–
        scanf("%d%d", &n, &m);
        for ( int i = 1; i <= n; i ++ ) 
                scanf("%d", &w[i]), 
                nums.push_back(w[i]);
        sort ( nums.begin(), nums.end() );
        nums.erase(unique(nums.begin(), nums.end()), nums.end());
        for ( int i = 1; i <= n; i ++ ) {
                w[i] = lower_bound(nums.begin(), nums.end(), w[i]) - nums.begin();
        }

        // å»ºå›¾
        memset(head, -1, sizeof head);
        for ( int i = 0; i < n - 1; i ++ ) {
                int a, b; scanf("%d%d", &a, &b);
                Add_Edge ( a, b );
                Add_Edge ( b, a );
        }

        // æ±‚æ¬§æ‹‰åºåˆ—
        dfs ( 1, -1 );
        // é¢„å¤„ç†æœ€è¿‘å…¬å…±ç¥–å…ˆ
        bfs ();
        
        // è¯¢é—®
        for ( int i = 0; i < m; i ++ ) {
                int a, b; scanf("%d%d", &a, &b); 
                // è½¬ç§»æˆçº¿æ€§åŒºé—´é—®é¢˜
                if ( first[a] > first[b] ) swap ( a, b );
                int p = lca ( a, b );
                if ( a == p ) q[i] = {i, first[a], first[b]};
                else q[i] = {i, last[a], first[b], p};
        }

        // åˆ†å—æ’åº
        len = sqrt ( top );
        sort ( q, q + m, [&]( Qry a, Qry b ) {
                if ( get(a.l) != get(b.l) ) return get(a.l) < get(b.l);
                if ( get(a.l) & 1 ) return a.r < b.r;
                else                return a.r > b.r;
        });
        
        // è«é˜ŸæŒ‡é’ˆæ“ä½œ
        for ( int i = 0, L = 1, R = 0; i < m; i ++ ) {
                int id = q[i].id, l = q[i].l, r = q[i].r, p = q[i].p;
                while ( R < r ) add ( seq[ ++ R ] );
                while ( R > r ) add ( seq[ R -- ] );
                while ( L < l ) add ( seq[ L ++ ] );
                while ( L > l ) add ( seq[ -- L ] );
                if ( p ) add ( p ); // å¦‚æœxä¸æ˜¯yçš„å…¬å…±ç¥–å…ˆçš„è¯è¦å…ˆåŠ ä¸Šå†å‡å»
                res[id] = RES;
                if ( p ) add ( p );
        }

        // è¾“å‡ºç­”æ¡ˆ
        for ( int i = 0; i < m; i ++ ) 
                printf("%d\n", res[i]);

        return 0;
}
```

## äºŒæ¬¡ç¦»çº¿è«é˜Ÿ

### é—®é¢˜ç±»å‹
>å®šä¹‰ä¸€ä¸ªæ–°çš„é…å¯¹å«ä¹‰ï¼šä¸¤ä¸ªæ•°å¼‚æˆ–åäºŒè¿›åˆ¶è¡¨ç¤ºæœ‰ $k$ ä¸ª $1$
é•¿åº¦ä¸º $n$ çš„åºåˆ—ï¼Œä¸€ä¸ª $k$ ï¼Œ $m$ æ¬¡è¯¢é—® $[l,r]$ å†…æœ‰å¤šå°‘ä¸ªæ•°å¯¹é…å¯¹  
è¿™ç±»é—®é¢˜æ¯æ¬¡æŒ‡é’ˆç§»åŠ¨ä¹‹åå¯¹æ•°æ®çš„ä¿®æ”¹å€¼éå¸¸éš¾ç®—  
   
è¿™ç±»é—®é¢˜å¯ä»¥æŠŠä¸€ä¸ªé—®é¢˜æ¨å¯¼æˆä¸¤ä¸ªé—®é¢˜ï¼Œä¸€ä¸ªé—®é¢˜ä½¿ç”¨è«é˜Ÿç¦»çº¿ç›´æ¥ç®—å‡ºåï¼Œå¯¹å¦ä¸€ä¸ªé—®é¢˜å†æ‹å‡ºæ¥ç¦»çº¿ç®—ä¸€æ¬¡  

### éå†åˆ†ç±»

å¯¹äº $[L,\;R\longrightarrow r]$  
  
åŸæ˜¯æ€æƒ³æ˜¯ $R$ å‘åç§»åŠ¨å¹¶åŠ å…¥ä¸€ä¸ªæ•°ï¼Œçœ‹<span style="color:red;">åŠ å…¥çš„è¿™ä¸ªæ•°å¯¹ç­”æ¡ˆä¼šä¸ä¼šäº§ç”Ÿä»€ä¹ˆä»·å€¼æˆ–å½±å“</span>  
åœ¨è¿™é‡ŒåŠ å…¥ $R+1$ æ—¶ï¼Œçœ‹ $R+1$ è¿™ä¸ªä½ç½®ä¸Šçš„æ•°èƒ½å’ŒåŸåŒºé—´å†…å¤šå°‘ä¸ªå…ƒç´ <span style="color:red;">äº§ç”Ÿé…å¯¹</span>  
  
æˆ‘ä»¬ä»¤  $S[R]$  è¡¨ç¤º  $[1,R]$  ä¸­å¤šå°‘ä¸ªæ•°ä¸  $R+1$  ä½ç½®é…å¯¹ï¼Œåˆ™ä¸Šé—®é¢˜çš„æ±‚æ³•å°±æ˜¯<span style="color:red;"> $S[R]-S[L-1]$ </span>  
  
è®¾ $f[i]$ è¡¨ç¤º $w[1]~w[i]$ ä¸­æœ‰å¤šå°‘ä¸ªæ•°ä¸ $w[i+1]$ é…å¯¹ï¼Œæ‰€ä»¥é—®é¢˜å…³é”®æŒ‡å‘<span style="color: red;">é¢„å¤„ç† $f[i]$ </span>  
è®¾ $g[i]$ è¡¨ç¤ºå‰ $i$ ä¸ªæ•°ä¸­æœ‰å¤šå°‘ä¸ªä¸ $i$ é…å¯¹ï¼Œåˆ™ $f[i]=g[w[i+1]]$    
å¯¹äºæ¯æ¬¡åŠ å…¥ä¸€ä¸ª $w[i$ æˆ‘ä»¬è¦å¯»æ‰¾å“ªäº›æ•°å’Œ $i$ é…å¯¹ï¼Œè®©ä»–ä»¬çš„ $g()++$   
æ‰€ä»¥æˆ‘ä»¬è¦å»ºä¸€ä¸ªæ•°ç»„å­˜æ”¾æ‰€æœ‰å­˜åœ¨ $k$ ä¸ª $1$ çš„æ•°  
è¦æ‰¾ $w[i]\otimes x=y[i]\Rightarrow x=w[i]\otimes y[i]$ éå†æ‰€æœ‰ $y[i]$ å¾—åˆ° $g$ è¦åŠ çš„æ•°ï¼Œæ‰€ä»¥æ˜¯å¯¹<span style="color: red;"> $g[w[i]\otimes y[i]]++$ </span>  
$g[i]$ è¿™ä¹ˆæ±‚ï¼Œé‚£ä¹ˆ $f[i]$ ä¹Ÿå‡ºæ¥äº†
    
$\therefore S[R]=f[R]$   
$S[L-1]$ç¦»çº¿æ±‚  
  
æˆ‘ä»¬åœ¨æ¨ $R\rightarrow r$ æ—¶ï¼Œæ¯ä¸ªæ•°åŠ è¿›æ¥éƒ½æ±‚ä¸€æ¬¡ $S[L-1]$   
é‚£ä¹ˆå°±æ˜¯ $[1,L-1]$ æ¯æ¬¡éƒ½é…å¯¹ä¸€ä¸‹ $[R+1,r]$ çš„æ•°  
å¯å°†è¿™äº›é—®é¢˜æ‹¿å‡ºæ¥ï¼Œæ¯ä¸ªé—®é¢˜ï¼šæŸä¸ªå›ºå®šå‰ç¼€ä¸­ï¼ŒæŸä¸ªåŒºé—´æ¯ä¸ªæ•°å’Œè¿™ä¸ªå‰ç¼€ä¸­å¤šå°‘ä¸ªæ•°é…å¯¹  
ä»å‰å¾€åæ±‚å‰ç¼€å³å‰ç¼€æ˜¯$1$çš„å“ªäº›è¯¢é—®å¯ä»¥å¹²æ‰ï¼Œ$2$çš„å“ªäº›è¯¢é—®å¯ä»¥å¹²æ‰ï¼Œ$3$çš„ï¼Œ......  
è¿™äº›éƒ½å¯ä»¥ç¦»çº¿åšä¸€éå‡ºæ¥  
  
é‚£ä¹ˆç¬¬ä¸€æ¬¡ç¦»çº¿å¾—åˆ° $S[R]$ ï¼Œå†ç¦»çº¿ä¸€æ¬¡ç»Ÿä¸€å‡º $S[L-1]$   
<span style="color: red;">æ³¨ï¼šæ¯æ¬¡æ±‚çš„ $S[R-S[L-1]]$ æ˜¯å¢é‡ $add$ çš„æ•°å€¼</span>  
  
>å¯¹äºå…¶ä»–çš„åˆ†ç±»è®¨è®ºæƒ…å†µä¹ŸåŒç†  

### ç®—æ³•æ¡†æ¶
|--é—®é¢˜æ¨å¯¼è½¬åŒ–ï¼Œåšä¸€ä¸ªå‰ç¼€å’Œåˆ†æˆä¸¤ä¸ªé—®é¢˜å»è§£  
|--è¯»å…¥æ•°æ®è¯»å…¥è¯¢é—®æ’åº    
|--éå†  
|----ç¬¬ä¸€æ¬¡è«é˜Ÿéå†æ±‚ç¬¬ä¸€ä¸ªé—®é¢˜   
|----ç¬¬äºŒæ¬¡é¡ºåºéå†æ±‚ç¬¬äºŒä¸ªé—®é¢˜  
|--åˆå¹¶ç­”æ¡ˆè¾“å‡º  
   
>[ã€æ¨¡æ¿ã€‘è«é˜ŸäºŒæ¬¡ç¦»çº¿ï¼ˆç¬¬åå››åˆ†å—(å‰ä½“)ï¼‰](https://www.luogu.com.cn/problem/P4887)

```cpp
const int N = 100010;
int n, m, k, len;
int w[N];
ll res[N];
struct Q {
        int id, l, r;
        ll RES; // å…ˆå­˜ä¸€ä¸‹ï¼Œåˆ†æˆä¸¤æ¬¡æ±‚å¾—
} q[N];
struct Range { // å¾…è§£å†³é—®é¢˜
        int id, l, r;
        int t; // åˆ¤æ–­è¦åŠ è¿˜æ˜¯å‡
};
vector<Range> range[N]; // å¯¹äºæ¯ä¸ªå‰ç¼€å¯èƒ½ä¼šæœ‰å¤šä¸ªè¯¢é—®åŒºé—´
int f[N], g[N]; // æ¨çš„å…¬å¼å…³ç³»çš„éœ€è¦çš„æ•°ç»„

inline int get ( int x ) { return x / len; }

inline int get_count ( int x ) { // æœ‰å¤šå°‘ä¸ª1
        int res = 0;
        while ( x ) res += x & 1, x >>= 1;
        return res;
}

int main () {
#ifndef ONLINE_JUDGE
        freopen("in.in", "r", stdin);
        freopen("out.out", "w", stdout);
#endif

        scanf("%d%d%d", &n, &m, &k);
        for ( int i = 1; i <= n; i ++ ) scanf("%d", &w[i]);
        
        // å­˜æ”¾æ‰€æœ‰æœ‰kä¸ª1çš„æ•°
        vector<int> nums; 
        for ( int i = 0; i < 1 << 14; i ++ )
                if ( get_count(i) == k ) 
                        nums.push_back(i);
        
        // åˆå§‹åŒ–fgæ•°ç»„
        for ( int i = 1; i <= n; i ++ ) {
                for ( auto x : nums ) g[w[i] ^ x] ++; // æ±‚å½“å‰æ–°åŠ çš„è¿™ä¸ªæ•°ï¼ˆw[i]ï¼‰å¯¹äºå“ªäº›xæ˜¯æœ‰å½±å“çš„
                f[i] = g[w[i + 1]]; // å…¬å¼å…³ç³»
        }

        // è¯»å…¥è¯¢é—®ï¼Œæ’åº
        for ( int i = 0; i < m; i ++ ) {
                int l, r; cin >> l >> r;
                q[i] = {i, l, r};
        }
        len = sqrt ( n );
        sort ( q, q + m, [] ( Q a ,Q b ) {
                if ( get(a.l) != get(b.l) ) return get(a.l) < get(b.l);
                return a.r < b.r;
        });

        // è«é˜Ÿ
        for ( int i = 0, L = 1, R = 0; i < m; i ++ ) {

                // S_R - S_{L - 1}
                if ( R < q[i].r ) range[L - 1].push_back({i, R + 1, q[i].r, -1}); // [R + 1, r] å…ˆä¸å¤„ç†ï¼ŒåŠ å…¥è¯¢é—®
                while ( R < q[i].r ) q[i].RES += f[ R ++ ];

                // - ( S_{R - 1} - S_{L - 1} )
                if ( R > q[i].r ) range[L - 1].push_back({i, q[i].r + 1, R, 1}); // [r + 1, R] å…ˆä¸å¤„ç†ï¼Œ åŠ å…¥è¯¢é—®
                while ( R > q[i].r ) q[i].RES -= f[ -- R ];

                // - ( S_R - S_L )
                if ( L < q[i].l ) range[R].push_back({i, L, q[i].l - 1, -1}); // [L, l - 1] å…ˆä¸å¤„ç†ï¼Œ åŠ å…¥è¯¢é—®
                while ( L < q[i].l ) q[i].RES += f[L - 1] + !k, L ++; // å› ä¸ºå­˜çš„æ˜¯[1, L - 1]æœ‰å¤šå°‘ä¸ªä¸Lé…å¯¹ï¼Œæ‰€ä»¥è¦å¤šåŠ ä¸ªåˆ¤æ–­w_Læ˜¯å¦é…å¯¹(k!=0)

                if ( L > q[i].l ) range[R].push_back({i, q[i].l, L - 1, 1}); // [l, L - 1] å…ˆä¸å¤„ç†ï¼Œ åŠ å…¥è¯¢é—®
                while ( L > q[i].l ) q[i].RES -= f[L - 2] + !k, L --;
        }

        // æ•´ä½“æ±‚ä¸€ä¸‹æ²¡æ±‚çš„éƒ¨åˆ†
        memset ( g, 0, sizeof g );
        for ( int i = 1; i <= n; i ++ ) { // æšä¸¾æ¯ä¸ªå‰ç¼€
                for ( auto x : nums ) g[w[i] ^ x] ++; // æšä¸¾æ‰€æœ‰æ»¡è¶³è¦æ±‚çš„y
                for ( auto& rg : range[i] ) {
                        for ( int x = rg.l; x <= rg.r; x ++ )
                                q[rg.id].RES += g[w[x]] * rg.t;
                }
        }

        // å› ä¸ºæ¯æ¬¡æ±‚çš„æ˜¯å¢é‡ï¼Œæ‰€ä»¥è¦ç´¯åŠ å‰ç¼€å’Œ
        for ( int i = 1; i < m; i ++ ) q[i].RES += q[i - 1].RES;
        for ( int i = 0; i < m; i ++ ) res[q[i].id] = q[i].RES;


        for ( int i = 0; i < m; i ++ ) printf("%lld\n", res[i]);
}
```

